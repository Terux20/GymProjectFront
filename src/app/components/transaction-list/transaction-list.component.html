<div class="container mt-4">
  <div class="d-flex justify-content-center align-items-center" *ngIf="isLoading" style="height: 100vh;">
    <app-loading-spinner></app-loading-spinner>
  </div>

  <div class="row" [class.content-blur]="isLoading">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">İşlem Geçmişi</h5>
          
          <div class="month-filter">
            <input type="month" class="form-control" 
                   [(ngModel)]="selectedMonth" 
                   (change)="filterByMonth()">
          </div>
        </div>

        <!-- İşlem özetleri -->
        <div class="card-body">
          <div class="summary-box mb-4">
            <div class="row">
              <div class="col-md-4">
                <div class="card bg-light">
                  <div class="card-body">
                    <h6 class="card-title">{{ getCurrentMonthText() }} Toplam</h6>
                    <h4>{{ getTotalAmount() | currency:'TRY':'symbol-narrow':'1.2-2' }}</h4>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card bg-success text-white">
                  <div class="card-body">
                    <h6 class="card-title">Ödenen</h6>
                    <h4>{{ getTotalPaidAmount() | currency:'TRY':'symbol-narrow':'1.2-2' }}</h4>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card bg-danger text-white">
                  <div class="card-body">
                    <h6 class="card-title">Ödenmeyen</h6>
                    <h4>{{ getTotalUnpaidAmount() | currency:'TRY':'symbol-narrow':'1.2-2' }}</h4>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- İşlem listesi -->
          <div class="table-responsive">
            <div class="member-group mb-4" *ngFor="let memberId of groupedTransactions | keyvalue">
              <div class="d-flex justify-content-between align-items-center bg-light p-3 mb-2">
                <h6 class="mb-0">{{ groupedTransactions[memberId.key][0].memberName }}</h6>
                <div class="d-flex align-items-center">
                  <span class="me-3 total-amount">Toplam Borç: {{ memberTotals[memberId.key] | currency:'TRY':'symbol-narrow':'1.2-2' }}</span>
                  <button class="btn btn-primary" *ngIf="memberTotals[memberId.key] > 0" (click)="updateAllMemberPayments(memberId.key)">
                    Tümünü Öde
                  </button>
                </div>
              </div>

              <table class="table">
                <thead>
                  <tr>
                    <th>Ürün</th>
                    <th>Adet</th>
                    <th>Birim Fiyat</th>
                    <th>Toplam Fiyat</th>
                    <th>İşlem Türü</th>
                    <th>Tarih</th>
                    <th>Ödeme Durumu</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let transaction of groupedTransactions[memberId.key]">
                    <td>{{ transaction.productName || "-" }}</td>
                    <td>{{ transaction.quantity }}</td>
                    <td>{{ transaction.unitPrice | currency:'TRY':'symbol-narrow':'1.2-2' }}</td>
                    <td>{{ transaction.amount | currency:'TRY':'symbol-narrow':'1.2-2' }}</td>
                    <td>{{ transaction.transactionType }}</td>
                    <td>{{ transaction.transactionDate | date:'dd/MM/yyyy HH:mm:ss' }}</td>
                    <td>
                      <span [class]="getStatusClass(transaction)"
                            (click)="updatePaymentStatus(transaction)"
                            [style.cursor]="transaction.transactionType === 'Bakiye Yükleme' || transaction.isPaid ? 'default' : 'pointer'"
                            [style.pointerEvents]="transaction.transactionType === 'Bakiye Yükleme' || transaction.isPaid ? 'none' : 'auto'">
                        {{ getPaymentStatus(transaction) }}
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>